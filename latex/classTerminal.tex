\hypertarget{classTerminal}{
\section{クラス Terminal}
\label{classTerminal}\index{Terminal@{Terminal}}
}


{\ttfamily \#include $<$terminal.hh$>$}Terminalに対する継承グラフ:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=3cm]{classTerminal}
\end{center}
\end{figure}
\subsection*{構成}
\begin{DoxyCompactItemize}
\item 
class \hyperlink{classTerminal_1_1DataEvent}{DataEvent}
\item 
class \hyperlink{classTerminal_1_1ListenEvent}{ListenEvent}
\item 
class \hyperlink{classTerminal_1_1Terminal}{Terminal}
\end{DoxyCompactItemize}
\subsection*{Public 型}
\begin{DoxyCompactItemize}
\item 
typedef TerminalParams \hyperlink{classTerminal_aa60a1659eb9e560503e47d6cbedd5ace}{Params}
\end{DoxyCompactItemize}
\subsection*{Public メソッド}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classTerminal_af67625ef23fe68d37a4fc8536c093b9f}{Terminal} (const \hyperlink{classTerminal_aa60a1659eb9e560503e47d6cbedd5ace}{Params} $\ast$p)
\item 
\hyperlink{classTerminal_a8495caff1d8ed60c107a562c9ceccbf3}{$\sim$Terminal} ()
\item 
void \hyperlink{classTerminal_a6617ba3e856d8b24979a2a44e5417172}{data} ()
\item 
void \hyperlink{classTerminal_ad584a0aa9613e91193e6d6649bf6c171}{read} (uint8\_\-t \&c)
\item 
size\_\-t \hyperlink{classTerminal_a9f8a094b410fa145da19663f83f241e3}{read} (uint8\_\-t $\ast$buf, size\_\-t len)
\item 
void \hyperlink{classTerminal_ada436a4b74c69ffbd4dc02b4b03d2cd3}{write} (uint8\_\-t c)
\item 
size\_\-t \hyperlink{classTerminal_a215d71301eb6ae0ebffc5d2f8fe4a140}{write} (const uint8\_\-t $\ast$buf, size\_\-t len)
\item 
void \hyperlink{classTerminal_ac295bade8aee589f6718dfa79edc2a34}{detach} ()
\item 
uint8\_\-t \hyperlink{classTerminal_a4200167e7f31117dce374e1885e36b1e}{in} ()
\item 
uint64\_\-t \hyperlink{classTerminal_abd9097353ba2e3b0552d2b731196e74a}{console\_\-in} ()
\item 
void \hyperlink{classTerminal_acc9adc1d382d03684010f95ae14318d4}{out} (char c)
\item 
bool \hyperlink{classTerminal_ae2c49c57a81bf30ab522f0eb98a45035}{dataAvailable} ()
\end{DoxyCompactItemize}
\subsection*{Public 変数}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classUart}{Uart} $\ast$ \hyperlink{classTerminal_a367b890cb271162bf5e8d879e09192cf}{uart}
\end{DoxyCompactItemize}
\subsection*{Protected メソッド}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{classTerminal_ac0c44c1417536740ffc2cf33117027cf}{listen} (int port)
\item 
void \hyperlink{classTerminal_aadb9f3b844fb4cf98288cd3c60a3af91}{accept} ()
\end{DoxyCompactItemize}
\subsection*{Protected 変数}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classTerminal_1_1ListenEvent}{ListenEvent} $\ast$ \hyperlink{classTerminal_ad7f258b1b869b6152bc5040c38b79d39}{listenEvent}
\item 
\hyperlink{classTerminal_1_1DataEvent}{DataEvent} $\ast$ \hyperlink{classTerminal_a7a8501aba170bc353fe057e372612b93}{dataEvent}
\item 
int \hyperlink{classTerminal_a7106e2abc437ad981830d14176d15f09}{number}
\item 
int \hyperlink{classTerminal_ae9994b62da601da68d4969c52d088910}{data\_\-fd}
\item 
\hyperlink{classListenSocket}{ListenSocket} \hyperlink{classTerminal_acf9ea448b26a541b4a197f1ca92f700b}{listener}
\item 
\hyperlink{classCircleBuf}{CircleBuf} \hyperlink{classTerminal_a49636a97ed2e363e47ffc2f0e2899b66}{txbuf}
\item 
\hyperlink{classCircleBuf}{CircleBuf} \hyperlink{classTerminal_af804c397682f3186a1fdd9919d93dea1}{rxbuf}
\item 
std::ostream $\ast$ \hyperlink{classTerminal_a15518d8416f4c0090ede0c9699a7bef8}{outfile}
\end{DoxyCompactItemize}
\subsection*{フレンド}
\begin{DoxyCompactItemize}
\item 
class \hyperlink{classTerminal_a9465cdda0008b0e7b7f9ac919cd9cca6}{ListenEvent}
\item 
class \hyperlink{classTerminal_a8a93830b802d4fc8562fa54ead43b1f9}{DataEvent}
\end{DoxyCompactItemize}


\subsection{型定義}
\hypertarget{classTerminal_aa60a1659eb9e560503e47d6cbedd5ace}{
\index{Terminal@{Terminal}!Params@{Params}}
\index{Params@{Params}!Terminal@{Terminal}}
\subsubsection[{Params}]{\setlength{\rightskip}{0pt plus 5cm}typedef TerminalParams {\bf Params}}}
\label{classTerminal_aa60a1659eb9e560503e47d6cbedd5ace}


\hyperlink{classSimObject_a0f0761d2db586a23bb2a2880b8f387bb}{SimObject}を再定義しています。

\subsection{コンストラクタとデストラクタ}
\hypertarget{classTerminal_af67625ef23fe68d37a4fc8536c093b9f}{
\index{Terminal@{Terminal}!Terminal@{Terminal}}
\index{Terminal@{Terminal}!Terminal@{Terminal}}
\subsubsection[{Terminal}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Terminal} (const {\bf Params} $\ast$ {\em p})}}
\label{classTerminal_af67625ef23fe68d37a4fc8536c093b9f}



\begin{DoxyCode}
102     : SimObject(p), listenEvent(NULL), dataEvent(NULL), number(p->number),
103       data_fd(-1), txbuf(16384), rxbuf(16384), outfile(NULL)
104 #if TRACING_ON == 1
105       , linebuf(16384)
106 #endif
107 {
108     if (p->output) {
109         outfile = simout.find(p->name);
110         if (!outfile)
111             outfile = simout.create(p->name);
112 
113         outfile->setf(ios::unitbuf);
114     }
115 
116     if (p->port)
117         listen(p->port);
118 }
\end{DoxyCode}
\hypertarget{classTerminal_a8495caff1d8ed60c107a562c9ceccbf3}{
\index{Terminal@{Terminal}!$\sim$Terminal@{$\sim$Terminal}}
\index{$\sim$Terminal@{$\sim$Terminal}!Terminal@{Terminal}}
\subsubsection[{$\sim$Terminal}]{\setlength{\rightskip}{0pt plus 5cm}$\sim${\bf Terminal} ()}}
\label{classTerminal_a8495caff1d8ed60c107a562c9ceccbf3}



\begin{DoxyCode}
121 {
122     if (data_fd != -1)
123         ::close(data_fd);
124 
125     if (listenEvent)
126         delete listenEvent;
127 
128     if (dataEvent)
129         delete dataEvent;
130 }
\end{DoxyCode}


\subsection{関数}
\hypertarget{classTerminal_aadb9f3b844fb4cf98288cd3c60a3af91}{
\index{Terminal@{Terminal}!accept@{accept}}
\index{accept@{accept}!Terminal@{Terminal}}
\subsubsection[{accept}]{\setlength{\rightskip}{0pt plus 5cm}void accept ()\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_aadb9f3b844fb4cf98288cd3c60a3af91}



\begin{DoxyCode}
163 {
164     if (!listener.islistening())
165         panic("%s: cannot accept a connection if not listening!", name());
166 
167     int fd = listener.accept(true);
168     if (data_fd != -1) {
169         char message[] = "terminal already attached!\n";
170         atomic_write(fd, message, sizeof(message));
171         ::close(fd);
172         return;
173     }
174 
175     data_fd = fd;
176     dataEvent = new DataEvent(this, data_fd, POLLIN);
177     pollQueue.schedule(dataEvent);
178 
179     stringstream stream;
180     ccprintf(stream, "==== m5 slave terminal: Terminal %d ====", number);
181 
182     // we need an actual carriage return followed by a newline for the
183     // terminal
184     stream << "\r\n";
185 
186     write((const uint8_t *)stream.str().c_str(), stream.str().size());
187 
188     DPRINTFN("attach terminal %d\n", number);
189 
190     txbuf.readall(data_fd);
191 }
\end{DoxyCode}
\hypertarget{classTerminal_abd9097353ba2e3b0552d2b731196e74a}{
\index{Terminal@{Terminal}!console\_\-in@{console\_\-in}}
\index{console\_\-in@{console\_\-in}!Terminal@{Terminal}}
\subsubsection[{console\_\-in}]{\setlength{\rightskip}{0pt plus 5cm}uint64\_\-t console\_\-in ()}}
\label{classTerminal_abd9097353ba2e3b0552d2b731196e74a}



\begin{DoxyCode}
280 {
281     uint64_t value;
282 
283     if (dataAvailable()) {
284         value = RECEIVE_SUCCESS | in();
285         if (!rxbuf.empty())
286             value  |= MORE_PENDING;
287     } else {
288         value = RECEIVE_NONE;
289     }
290 
291     DPRINTF(TerminalVerbose, "console_in: return: %#x\n", value);
292 
293     return value;
294 }
\end{DoxyCode}
\hypertarget{classTerminal_a6617ba3e856d8b24979a2a44e5417172}{
\index{Terminal@{Terminal}!data@{data}}
\index{data@{data}!Terminal@{Terminal}}
\subsubsection[{data}]{\setlength{\rightskip}{0pt plus 5cm}void data ()}}
\label{classTerminal_a6617ba3e856d8b24979a2a44e5417172}



\begin{DoxyCode}
210 {
211     uint8_t buf[1024];
212     int len;
213 
214     len = read(buf, sizeof(buf));
215     if (len) {
216         rxbuf.write((char *)buf, len);
217         // Inform the UART there is data available
218         uart->dataAvailable();
219     }
220 }
\end{DoxyCode}
\hypertarget{classTerminal_ae2c49c57a81bf30ab522f0eb98a45035}{
\index{Terminal@{Terminal}!dataAvailable@{dataAvailable}}
\index{dataAvailable@{dataAvailable}!Terminal@{Terminal}}
\subsubsection[{dataAvailable}]{\setlength{\rightskip}{0pt plus 5cm}bool dataAvailable ()\hspace{0.3cm}{\ttfamily  \mbox{[}inline\mbox{]}}}}
\label{classTerminal_ae2c49c57a81bf30ab522f0eb98a45035}



\begin{DoxyCode}
143 { return !rxbuf.empty(); }
\end{DoxyCode}
\hypertarget{classTerminal_ac295bade8aee589f6718dfa79edc2a34}{
\index{Terminal@{Terminal}!detach@{detach}}
\index{detach@{detach}!Terminal@{Terminal}}
\subsubsection[{detach}]{\setlength{\rightskip}{0pt plus 5cm}void detach ()}}
\label{classTerminal_ac295bade8aee589f6718dfa79edc2a34}



\begin{DoxyCode}
195 {
196     if (data_fd != -1) {
197         ::close(data_fd);
198         data_fd = -1;
199     }
200 
201     pollQueue.remove(dataEvent);
202     delete dataEvent;
203     dataEvent = NULL;
204 
205     DPRINTFN("detach terminal %d\n", number);
206 }
\end{DoxyCode}
\hypertarget{classTerminal_a4200167e7f31117dce374e1885e36b1e}{
\index{Terminal@{Terminal}!in@{in}}
\index{in@{in}!Terminal@{Terminal}}
\subsubsection[{in}]{\setlength{\rightskip}{0pt plus 5cm}uint8\_\-t in ()}}
\label{classTerminal_a4200167e7f31117dce374e1885e36b1e}



\begin{DoxyCode}
266 {
267     uint8_t c;
268 
269     assert(!rxbuf.empty());
270     rxbuf.read((char *)&c, 1);
271 
272     DPRINTF(TerminalVerbose, "in: \'%c\' %#02x more: %d\n",
273             isprint(c) ? c : ' ', c, !rxbuf.empty());
274 
275     return c;
276 }
\end{DoxyCode}
\hypertarget{classTerminal_ac0c44c1417536740ffc2cf33117027cf}{
\index{Terminal@{Terminal}!listen@{listen}}
\index{listen@{listen}!Terminal@{Terminal}}
\subsubsection[{listen}]{\setlength{\rightskip}{0pt plus 5cm}void listen (int {\em port})\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_ac0c44c1417536740ffc2cf33117027cf}



\begin{DoxyCode}
138 {
139     if (ListenSocket::allDisabled()) {
140         warn_once("Sockets disabled, not accepting terminal connections");
141         return;
142     }
143 
144     while (!listener.listen(port, true)) {
145         DPRINTF(Terminal,
146                 ": can't bind address terminal port %d inuse PID %d\n",
147                 port, getpid());
148         port++;
149     }
150 
151     int p1, p2;
152     p2 = name().rfind('.') - 1;
153     p1 = name().rfind('.', p2);
154     ccprintf(cerr, "Listening for %s connection on port %d\n",
155             name().substr(p1+1,p2-p1), port);
156 
157     listenEvent = new ListenEvent(this, listener.getfd(), POLLIN);
158     pollQueue.schedule(listenEvent);
159 }
\end{DoxyCode}
\hypertarget{classTerminal_acc9adc1d382d03684010f95ae14318d4}{
\index{Terminal@{Terminal}!out@{out}}
\index{out@{out}!Terminal@{Terminal}}
\subsubsection[{out}]{\setlength{\rightskip}{0pt plus 5cm}void out (char {\em c})}}
\label{classTerminal_acc9adc1d382d03684010f95ae14318d4}



\begin{DoxyCode}
298 {
299 #if TRACING_ON == 1
300     if (DTRACE(Terminal)) {
301         static char last = '\0';
302 
303         if ((c != '\n' && c != '\r') || (last != '\n' && last != '\r')) {
304             if (c == '\n' || c == '\r') {
305                 int size = linebuf.size();
306                 char *buffer = new char[size + 1];
307                 linebuf.read(buffer, size);
308                 buffer[size] = '\0';
309                 DPRINTF(Terminal, "%s\n", buffer);
310                 delete [] buffer;
311             } else {
312                 linebuf.write(c);
313             }
314         }
315 
316         last = c;
317     }
318 #endif
319 
320     txbuf.write(c);
321 
322     if (data_fd >= 0)
323         write(c);
324 
325     if (outfile)
326         outfile->write(&c, 1);
327 
328     DPRINTF(TerminalVerbose, "out: \'%c\' %#02x\n",
329             isprint(c) ? c : ' ', (int)c);
330 
331 }
\end{DoxyCode}
\hypertarget{classTerminal_a9f8a094b410fa145da19663f83f241e3}{
\index{Terminal@{Terminal}!read@{read}}
\index{read@{read}!Terminal@{Terminal}}
\subsubsection[{read}]{\setlength{\rightskip}{0pt plus 5cm}size\_\-t read (uint8\_\-t $\ast$ {\em buf}, \/  size\_\-t {\em len})}}
\label{classTerminal_a9f8a094b410fa145da19663f83f241e3}



\begin{DoxyCode}
224 {
225     if (data_fd < 0)
226         panic("Terminal not properly attached.\n");
227 
228     size_t ret;
229     do {
230       ret = ::read(data_fd, buf, len);
231     } while (ret == -1 && errno == EINTR);
232 
233 
234     if (ret < 0)
235         DPRINTFN("Read failed.\n");
236 
237     if (ret <= 0) {
238         detach();
239         return 0;
240     }
241 
242     return ret;
243 }
\end{DoxyCode}
\hypertarget{classTerminal_ad584a0aa9613e91193e6d6649bf6c171}{
\index{Terminal@{Terminal}!read@{read}}
\index{read@{read}!Terminal@{Terminal}}
\subsubsection[{read}]{\setlength{\rightskip}{0pt plus 5cm}void read (uint8\_\-t \& {\em c})\hspace{0.3cm}{\ttfamily  \mbox{[}inline\mbox{]}}}}
\label{classTerminal_ad584a0aa9613e91193e6d6649bf6c171}



\begin{DoxyCode}
112 { read(&c, 1); }
\end{DoxyCode}
\hypertarget{classTerminal_a215d71301eb6ae0ebffc5d2f8fe4a140}{
\index{Terminal@{Terminal}!write@{write}}
\index{write@{write}!Terminal@{Terminal}}
\subsubsection[{write}]{\setlength{\rightskip}{0pt plus 5cm}size\_\-t write (const uint8\_\-t $\ast$ {\em buf}, \/  size\_\-t {\em len})}}
\label{classTerminal_a215d71301eb6ae0ebffc5d2f8fe4a140}



\begin{DoxyCode}
248 {
249     if (data_fd < 0)
250         panic("Terminal not properly attached.\n");
251 
252     ssize_t ret = atomic_write(data_fd, buf, len);
253     if (ret < len)
254         detach();
255 
256     return ret;
257 }
\end{DoxyCode}
\hypertarget{classTerminal_ada436a4b74c69ffbd4dc02b4b03d2cd3}{
\index{Terminal@{Terminal}!write@{write}}
\index{write@{write}!Terminal@{Terminal}}
\subsubsection[{write}]{\setlength{\rightskip}{0pt plus 5cm}void write (uint8\_\-t {\em c})\hspace{0.3cm}{\ttfamily  \mbox{[}inline\mbox{]}}}}
\label{classTerminal_ada436a4b74c69ffbd4dc02b4b03d2cd3}



\begin{DoxyCode}
114 { write(&c, 1); }
\end{DoxyCode}


\subsection{フレンドと関連する関数}
\hypertarget{classTerminal_a8a93830b802d4fc8562fa54ead43b1f9}{
\index{Terminal@{Terminal}!DataEvent@{DataEvent}}
\index{DataEvent@{DataEvent}!Terminal@{Terminal}}
\subsubsection[{DataEvent}]{\setlength{\rightskip}{0pt plus 5cm}friend class {\bf DataEvent}\hspace{0.3cm}{\ttfamily  \mbox{[}friend\mbox{]}}}}
\label{classTerminal_a8a93830b802d4fc8562fa54ead43b1f9}
\hypertarget{classTerminal_a9465cdda0008b0e7b7f9ac919cd9cca6}{
\index{Terminal@{Terminal}!ListenEvent@{ListenEvent}}
\index{ListenEvent@{ListenEvent}!Terminal@{Terminal}}
\subsubsection[{ListenEvent}]{\setlength{\rightskip}{0pt plus 5cm}friend class {\bf ListenEvent}\hspace{0.3cm}{\ttfamily  \mbox{[}friend\mbox{]}}}}
\label{classTerminal_a9465cdda0008b0e7b7f9ac919cd9cca6}


\subsection{変数}
\hypertarget{classTerminal_ae9994b62da601da68d4969c52d088910}{
\index{Terminal@{Terminal}!data\_\-fd@{data\_\-fd}}
\index{data\_\-fd@{data\_\-fd}!Terminal@{Terminal}}
\subsubsection[{data\_\-fd}]{\setlength{\rightskip}{0pt plus 5cm}int {\bf data\_\-fd}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_ae9994b62da601da68d4969c52d088910}
\hypertarget{classTerminal_a7a8501aba170bc353fe057e372612b93}{
\index{Terminal@{Terminal}!dataEvent@{dataEvent}}
\index{dataEvent@{dataEvent}!Terminal@{Terminal}}
\subsubsection[{dataEvent}]{\setlength{\rightskip}{0pt plus 5cm}{\bf DataEvent}$\ast$ {\bf dataEvent}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_a7a8501aba170bc353fe057e372612b93}
\hypertarget{classTerminal_acf9ea448b26a541b4a197f1ca92f700b}{
\index{Terminal@{Terminal}!listener@{listener}}
\index{listener@{listener}!Terminal@{Terminal}}
\subsubsection[{listener}]{\setlength{\rightskip}{0pt plus 5cm}{\bf ListenSocket} {\bf listener}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_acf9ea448b26a541b4a197f1ca92f700b}
\hypertarget{classTerminal_ad7f258b1b869b6152bc5040c38b79d39}{
\index{Terminal@{Terminal}!listenEvent@{listenEvent}}
\index{listenEvent@{listenEvent}!Terminal@{Terminal}}
\subsubsection[{listenEvent}]{\setlength{\rightskip}{0pt plus 5cm}{\bf ListenEvent}$\ast$ {\bf listenEvent}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_ad7f258b1b869b6152bc5040c38b79d39}
\hypertarget{classTerminal_a7106e2abc437ad981830d14176d15f09}{
\index{Terminal@{Terminal}!number@{number}}
\index{number@{number}!Terminal@{Terminal}}
\subsubsection[{number}]{\setlength{\rightskip}{0pt plus 5cm}int {\bf number}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_a7106e2abc437ad981830d14176d15f09}
\hypertarget{classTerminal_a15518d8416f4c0090ede0c9699a7bef8}{
\index{Terminal@{Terminal}!outfile@{outfile}}
\index{outfile@{outfile}!Terminal@{Terminal}}
\subsubsection[{outfile}]{\setlength{\rightskip}{0pt plus 5cm}std::ostream$\ast$ {\bf outfile}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_a15518d8416f4c0090ede0c9699a7bef8}
\hypertarget{classTerminal_af804c397682f3186a1fdd9919d93dea1}{
\index{Terminal@{Terminal}!rxbuf@{rxbuf}}
\index{rxbuf@{rxbuf}!Terminal@{Terminal}}
\subsubsection[{rxbuf}]{\setlength{\rightskip}{0pt plus 5cm}{\bf CircleBuf} {\bf rxbuf}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_af804c397682f3186a1fdd9919d93dea1}
\hypertarget{classTerminal_a49636a97ed2e363e47ffc2f0e2899b66}{
\index{Terminal@{Terminal}!txbuf@{txbuf}}
\index{txbuf@{txbuf}!Terminal@{Terminal}}
\subsubsection[{txbuf}]{\setlength{\rightskip}{0pt plus 5cm}{\bf CircleBuf} {\bf txbuf}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classTerminal_a49636a97ed2e363e47ffc2f0e2899b66}
\hypertarget{classTerminal_a367b890cb271162bf5e8d879e09192cf}{
\index{Terminal@{Terminal}!uart@{uart}}
\index{uart@{uart}!Terminal@{Terminal}}
\subsubsection[{uart}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Uart}$\ast$ {\bf uart}}}
\label{classTerminal_a367b890cb271162bf5e8d879e09192cf}


このクラスの説明は次のファイルから生成されました:\begin{DoxyCompactItemize}
\item 
dev/\hyperlink{terminal_8hh}{terminal.hh}\item 
dev/\hyperlink{terminal_8cc}{terminal.cc}\end{DoxyCompactItemize}
