\hypertarget{classCowDiskImage}{
\section{クラス CowDiskImage}
\label{classCowDiskImage}\index{CowDiskImage@{CowDiskImage}}
}


{\ttfamily \#include $<$disk\_\-image.hh$>$}CowDiskImageに対する継承グラフ:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=4cm]{classCowDiskImage}
\end{center}
\end{figure}
\subsection*{構成}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structCowDiskImage_1_1Sector}{Sector}
\end{DoxyCompactItemize}
\subsection*{Public 型}
\begin{DoxyCompactItemize}
\item 
typedef CowDiskImageParams \hyperlink{classCowDiskImage_a564df726143da4914743e9d8c1a17c6c}{Params}
\end{DoxyCompactItemize}
\subsection*{Public メソッド}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classCowDiskImage_ad27dd208186bea9d387d4f83cf605679}{CowDiskImage} (const \hyperlink{classCowDiskImage_a564df726143da4914743e9d8c1a17c6c}{Params} $\ast$p)
\item 
\hyperlink{classCowDiskImage_a95d88dc63c0c2dd7c28f255cfbe2e8f5}{$\sim$CowDiskImage} ()
\item 
void \hyperlink{classCowDiskImage_a68d4538305e2037525db5bdbb9e8881e}{initSectorTable} (int hash\_\-size)
\item 
bool \hyperlink{classCowDiskImage_a5acc5a46099815559b3081f2fa5c3464}{open} (const std::string \&file)
\item 
void \hyperlink{classCowDiskImage_aae2c382151ef7c9aa913361172b30db6}{save} ()
\item 
void \hyperlink{classCowDiskImage_a7b34aadc98977c91db5b87747f7e7ea9}{save} (const std::string \&file)
\item 
void \hyperlink{classCowDiskImage_a9e578fb7567063e3ea37096c827e0412}{writeback} ()
\item 
void \hyperlink{classCowDiskImage_a53e036786d17361be4c7320d39c99b84}{serialize} (std::ostream \&os)
\item 
void \hyperlink{classCowDiskImage_af22e5d6d660b97db37003ac61ac4ee49}{unserialize} (\hyperlink{classCheckpoint}{Checkpoint} $\ast$cp, const std::string \&section)
\item 
virtual std::streampos \hyperlink{classCowDiskImage_ac47c8c9bb5ae5fbfa7e05b464d3e20d4}{size} () const 
\item 
virtual std::streampos \hyperlink{classCowDiskImage_ab2e0b5adfb9d2c78b1e534efa2af6e45}{read} (uint8\_\-t $\ast$data, std::streampos offset) const 
\item 
virtual std::streampos \hyperlink{classCowDiskImage_aadff68e91a6ca912a1878d79af3d0692}{write} (const uint8\_\-t $\ast$data, std::streampos offset)
\end{DoxyCompactItemize}
\subsection*{Static Public 変数}
\begin{DoxyCompactItemize}
\item 
static const \hyperlink{Type_8hh_a435d1572bf3f880d55459d9805097f62}{uint32\_\-t} \hyperlink{classCowDiskImage_aea9111b09377b8ceea1a83f731859e94}{VersionMajor} = 1
\item 
static const \hyperlink{Type_8hh_a435d1572bf3f880d55459d9805097f62}{uint32\_\-t} \hyperlink{classCowDiskImage_ab69a15e46e9c6523e2b08bcff16b3013}{VersionMinor} = 0
\end{DoxyCompactItemize}
\subsection*{Protected 型}
\begin{DoxyCompactItemize}
\item 
typedef m5::hash\_\-map$<$ uint64\_\-t, \hyperlink{structCowDiskImage_1_1Sector}{Sector} $\ast$ $>$ \hyperlink{classCowDiskImage_a22b16d3053a4078053e44e56fe64875d}{SectorTable}
\end{DoxyCompactItemize}
\subsection*{Protected 変数}
\begin{DoxyCompactItemize}
\item 
std::string \hyperlink{classCowDiskImage_ae80f820219e45772366a2a68de6a54c4}{filename}
\item 
\hyperlink{classDiskImage_1_1DiskImage}{DiskImage} $\ast$ \hyperlink{classCowDiskImage_a3053e924a69d07b168217ad41e6b877b}{child}
\item 
\hyperlink{classCowDiskImage_a22b16d3053a4078053e44e56fe64875d}{SectorTable} $\ast$ \hyperlink{classCowDiskImage_a98c079cb623ba6bc8bf495e981e80c43}{table}
\end{DoxyCompactItemize}


\subsection{説明}
Specialization for accessing a copy-\/on-\/write disk image layer. A copy-\/on-\/write(COW) layer must be stacked on top of another disk image layer this layer can be another \hyperlink{classCowDiskImage}{CowDiskImage}, or a \hyperlink{classRawDiskImage}{RawDiskImage}.

This object is designed to provide a mechanism for persistant changes to a main disk image, or to provide a place for temporary changes to the image to take place that later may be thrown away. 

\subsection{型定義}
\hypertarget{classCowDiskImage_a564df726143da4914743e9d8c1a17c6c}{
\index{CowDiskImage@{CowDiskImage}!Params@{Params}}
\index{Params@{Params}!CowDiskImage@{CowDiskImage}}
\subsubsection[{Params}]{\setlength{\rightskip}{0pt plus 5cm}typedef CowDiskImageParams {\bf Params}}}
\label{classCowDiskImage_a564df726143da4914743e9d8c1a17c6c}


\hyperlink{classDiskImage_a7fcdce57df9801d7eebcb65f9ad2e0c0}{DiskImage}を再定義しています。\hypertarget{classCowDiskImage_a22b16d3053a4078053e44e56fe64875d}{
\index{CowDiskImage@{CowDiskImage}!SectorTable@{SectorTable}}
\index{SectorTable@{SectorTable}!CowDiskImage@{CowDiskImage}}
\subsubsection[{SectorTable}]{\setlength{\rightskip}{0pt plus 5cm}typedef m5::hash\_\-map$<$uint64\_\-t, {\bf Sector} $\ast$$>$ {\bf SectorTable}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classCowDiskImage_a22b16d3053a4078053e44e56fe64875d}


\subsection{コンストラクタとデストラクタ}
\hypertarget{classCowDiskImage_ad27dd208186bea9d387d4f83cf605679}{
\index{CowDiskImage@{CowDiskImage}!CowDiskImage@{CowDiskImage}}
\index{CowDiskImage@{CowDiskImage}!CowDiskImage@{CowDiskImage}}
\subsubsection[{CowDiskImage}]{\setlength{\rightskip}{0pt plus 5cm}{\bf CowDiskImage} (const {\bf Params} $\ast$ {\em p})}}
\label{classCowDiskImage_ad27dd208186bea9d387d4f83cf605679}



\begin{DoxyCode}
172     : DiskImage(p), filename(p->image_file), child(p->child), table(NULL)
173 {
174     if (filename.empty()) {
175         initSectorTable(p->table_size);
176     } else {
177         if (!open(filename)) {
178             if (p->read_only)
179                 fatal("could not open read-only file");
180             initSectorTable(p->table_size);
181         }
182 
183         if (!p->read_only)
184             registerExitCallback(new CowDiskCallback(this));
185     }
186 }
\end{DoxyCode}
\hypertarget{classCowDiskImage_a95d88dc63c0c2dd7c28f255cfbe2e8f5}{
\index{CowDiskImage@{CowDiskImage}!$\sim$CowDiskImage@{$\sim$CowDiskImage}}
\index{$\sim$CowDiskImage@{$\sim$CowDiskImage}!CowDiskImage@{CowDiskImage}}
\subsubsection[{$\sim$CowDiskImage}]{\setlength{\rightskip}{0pt plus 5cm}$\sim${\bf CowDiskImage} ()}}
\label{classCowDiskImage_a95d88dc63c0c2dd7c28f255cfbe2e8f5}



\begin{DoxyCode}
189 {
190     SectorTable::iterator i = table->begin();
191     SectorTable::iterator end = table->end();
192 
193     while (i != end) {
194         delete (*i).second;
195         ++i;
196     }
197 }
\end{DoxyCode}


\subsection{関数}
\hypertarget{classCowDiskImage_a68d4538305e2037525db5bdbb9e8881e}{
\index{CowDiskImage@{CowDiskImage}!initSectorTable@{initSectorTable}}
\index{initSectorTable@{initSectorTable}!CowDiskImage@{CowDiskImage}}
\subsubsection[{initSectorTable}]{\setlength{\rightskip}{0pt plus 5cm}void initSectorTable (int {\em hash\_\-size})}}
\label{classCowDiskImage_a68d4538305e2037525db5bdbb9e8881e}



\begin{DoxyCode}
276 {
277     table = new SectorTable(hash_size);
278 
279     initialized = true;
280 }
\end{DoxyCode}
\hypertarget{classCowDiskImage_a5acc5a46099815559b3081f2fa5c3464}{
\index{CowDiskImage@{CowDiskImage}!open@{open}}
\index{open@{open}!CowDiskImage@{CowDiskImage}}
\subsubsection[{open}]{\setlength{\rightskip}{0pt plus 5cm}bool open (const std::string \& {\em file})}}
\label{classCowDiskImage_a5acc5a46099815559b3081f2fa5c3464}
\hypertarget{classCowDiskImage_ab2e0b5adfb9d2c78b1e534efa2af6e45}{
\index{CowDiskImage@{CowDiskImage}!read@{read}}
\index{read@{read}!CowDiskImage@{CowDiskImage}}
\subsubsection[{read}]{\setlength{\rightskip}{0pt plus 5cm}std::streampos read (uint8\_\-t $\ast$ {\em data}, \/  std::streampos {\em offset}) const\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}
\label{classCowDiskImage_ab2e0b5adfb9d2c78b1e534efa2af6e45}


\hyperlink{classDiskImage_afcf02c1fffcb16ed79ac38bb87fb572c}{DiskImage}を実装しています。


\begin{DoxyCode}
368 {
369     if (!initialized)
370         panic("CowDiskImage not initialized");
371 
372     if (offset > size())
373         panic("access out of bounds");
374 
375     SectorTable::const_iterator i = table->find(offset);
376     if (i == table->end())
377         return child->read(data, offset);
378     else {
379         memcpy(data, (*i).second->data, SectorSize);
380         DPRINTF(DiskImageRead, "read: offset=%d\n", (uint64_t)offset);
381         DDUMP(DiskImageRead, data, SectorSize);
382         return SectorSize;
383     }
384 }
\end{DoxyCode}
\hypertarget{classCowDiskImage_a7b34aadc98977c91db5b87747f7e7ea9}{
\index{CowDiskImage@{CowDiskImage}!save@{save}}
\index{save@{save}!CowDiskImage@{CowDiskImage}}
\subsubsection[{save}]{\setlength{\rightskip}{0pt plus 5cm}void save (const std::string \& {\em file})}}
\label{classCowDiskImage_a7b34aadc98977c91db5b87747f7e7ea9}
\hypertarget{classCowDiskImage_aae2c382151ef7c9aa913361172b30db6}{
\index{CowDiskImage@{CowDiskImage}!save@{save}}
\index{save@{save}!CowDiskImage@{CowDiskImage}}
\subsubsection[{save}]{\setlength{\rightskip}{0pt plus 5cm}void save ()}}
\label{classCowDiskImage_aae2c382151ef7c9aa913361172b30db6}



\begin{DoxyCode}
312 {
313     save(filename);
314 }
\end{DoxyCode}
\hypertarget{classCowDiskImage_a53e036786d17361be4c7320d39c99b84}{
\index{CowDiskImage@{CowDiskImage}!serialize@{serialize}}
\index{serialize@{serialize}!CowDiskImage@{CowDiskImage}}
\subsubsection[{serialize}]{\setlength{\rightskip}{0pt plus 5cm}void serialize (std::ostream \& {\em os})\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}
\label{classCowDiskImage_a53e036786d17361be4c7320d39c99b84}


\hyperlink{classSerializable_ad6272f80ae37e8331e3969b3f072a801}{Serializable}を再定義しています。\hypertarget{classCowDiskImage_ac47c8c9bb5ae5fbfa7e05b464d3e20d4}{
\index{CowDiskImage@{CowDiskImage}!size@{size}}
\index{size@{size}!CowDiskImage@{CowDiskImage}}
\subsubsection[{size}]{\setlength{\rightskip}{0pt plus 5cm}std::streampos size () const\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}
\label{classCowDiskImage_ac47c8c9bb5ae5fbfa7e05b464d3e20d4}


\hyperlink{classDiskImage_a0e772d58951a6696fce770bd4c390e9f}{DiskImage}を実装しています。


\begin{DoxyCode}
364 { return child->size(); }
\end{DoxyCode}
\hypertarget{classCowDiskImage_af22e5d6d660b97db37003ac61ac4ee49}{
\index{CowDiskImage@{CowDiskImage}!unserialize@{unserialize}}
\index{unserialize@{unserialize}!CowDiskImage@{CowDiskImage}}
\subsubsection[{unserialize}]{\setlength{\rightskip}{0pt plus 5cm}void unserialize ({\bf Checkpoint} $\ast$ {\em cp}, \/  const std::string \& {\em section})\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}
\label{classCowDiskImage_af22e5d6d660b97db37003ac61ac4ee49}


\hyperlink{classSerializable_af100c4e9feabf3cd918619c88c718387}{Serializable}を再定義しています。\hypertarget{classCowDiskImage_aadff68e91a6ca912a1878d79af3d0692}{
\index{CowDiskImage@{CowDiskImage}!write@{write}}
\index{write@{write}!CowDiskImage@{CowDiskImage}}
\subsubsection[{write}]{\setlength{\rightskip}{0pt plus 5cm}std::streampos write (const uint8\_\-t $\ast$ {\em data}, \/  std::streampos {\em offset})\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}
\label{classCowDiskImage_aadff68e91a6ca912a1878d79af3d0692}


\hyperlink{classDiskImage_a42c90a80133a988d65ab33cc4d31d168}{DiskImage}を実装しています。


\begin{DoxyCode}
388 {
389     if (!initialized)
390         panic("RawDiskImage not initialized");
391 
392     if (offset > size())
393         panic("access out of bounds");
394 
395     SectorTable::iterator i = table->find(offset);
396     if (i == table->end()) {
397         Sector *sector = new Sector;
398         memcpy(sector, data, SectorSize);
399         table->insert(make_pair(offset, sector));
400     } else {
401         memcpy((*i).second->data, data, SectorSize);
402     }
403 
404     DPRINTF(DiskImageWrite, "write: offset=%d\n", (uint64_t)offset);
405     DDUMP(DiskImageWrite, data, SectorSize);
406 
407     return SectorSize;
408 }
\end{DoxyCode}
\hypertarget{classCowDiskImage_a9e578fb7567063e3ea37096c827e0412}{
\index{CowDiskImage@{CowDiskImage}!writeback@{writeback}}
\index{writeback@{writeback}!CowDiskImage@{CowDiskImage}}
\subsubsection[{writeback}]{\setlength{\rightskip}{0pt plus 5cm}void writeback ()}}
\label{classCowDiskImage_a9e578fb7567063e3ea37096c827e0412}



\begin{DoxyCode}
352 {
353     SectorTable::iterator i = table->begin();
354     SectorTable::iterator end = table->end();
355 
356     while (i != end) {
357         child->write((*i).second->data, (*i).first);
358         ++i;
359     }
360 }
\end{DoxyCode}


\subsection{変数}
\hypertarget{classCowDiskImage_a3053e924a69d07b168217ad41e6b877b}{
\index{CowDiskImage@{CowDiskImage}!child@{child}}
\index{child@{child}!CowDiskImage@{CowDiskImage}}
\subsubsection[{child}]{\setlength{\rightskip}{0pt plus 5cm}{\bf DiskImage}$\ast$ {\bf child}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classCowDiskImage_a3053e924a69d07b168217ad41e6b877b}
\hypertarget{classCowDiskImage_ae80f820219e45772366a2a68de6a54c4}{
\index{CowDiskImage@{CowDiskImage}!filename@{filename}}
\index{filename@{filename}!CowDiskImage@{CowDiskImage}}
\subsubsection[{filename}]{\setlength{\rightskip}{0pt plus 5cm}std::string {\bf filename}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classCowDiskImage_ae80f820219e45772366a2a68de6a54c4}
\hypertarget{classCowDiskImage_a98c079cb623ba6bc8bf495e981e80c43}{
\index{CowDiskImage@{CowDiskImage}!table@{table}}
\index{table@{table}!CowDiskImage@{CowDiskImage}}
\subsubsection[{table}]{\setlength{\rightskip}{0pt plus 5cm}{\bf SectorTable}$\ast$ {\bf table}\hspace{0.3cm}{\ttfamily  \mbox{[}protected\mbox{]}}}}
\label{classCowDiskImage_a98c079cb623ba6bc8bf495e981e80c43}
\hypertarget{classCowDiskImage_aea9111b09377b8ceea1a83f731859e94}{
\index{CowDiskImage@{CowDiskImage}!VersionMajor@{VersionMajor}}
\index{VersionMajor@{VersionMajor}!CowDiskImage@{CowDiskImage}}
\subsubsection[{VersionMajor}]{\setlength{\rightskip}{0pt plus 5cm}const {\bf uint32\_\-t} {\bf VersionMajor} = 1\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}
\label{classCowDiskImage_aea9111b09377b8ceea1a83f731859e94}
\hypertarget{classCowDiskImage_ab69a15e46e9c6523e2b08bcff16b3013}{
\index{CowDiskImage@{CowDiskImage}!VersionMinor@{VersionMinor}}
\index{VersionMinor@{VersionMinor}!CowDiskImage@{CowDiskImage}}
\subsubsection[{VersionMinor}]{\setlength{\rightskip}{0pt plus 5cm}const {\bf uint32\_\-t} {\bf VersionMinor} = 0\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}
\label{classCowDiskImage_ab69a15e46e9c6523e2b08bcff16b3013}


このクラスの説明は次のファイルから生成されました:\begin{DoxyCompactItemize}
\item 
dev/\hyperlink{disk__image_8hh}{disk\_\-image.hh}\item 
dev/\hyperlink{disk__image_8cc}{disk\_\-image.cc}\end{DoxyCompactItemize}
